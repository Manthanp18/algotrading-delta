<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trading Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0a0a0a; color: #e0e0e0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .header h1 { color: #00ff88; font-size: 2.5rem; margin-bottom: 10px; }
        .status-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
        .status-active { background: #00ff88; color: #000; }
        .status-inactive { background: #ff4444; color: #fff; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 20px; text-align: center; }
        .metric-value { font-size: 2rem; font-weight: bold; margin-bottom: 8px; }
        .metric-label { color: #888; font-size: 0.9rem; text-transform: uppercase; }
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .section { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; margin-bottom: 30px; overflow: hidden; }
        .section-header { background: #2a2a2a; padding: 15px 20px; border-bottom: 1px solid #333; }
        .section-title { font-size: 1.2rem; font-weight: bold; color: #00ff88; }
        .trades-table { width: 100%; border-collapse: collapse; }
        .trades-table th, .trades-table td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        .trades-table th { background: #2a2a2a; color: #00ff88; font-weight: bold; font-size: 0.9rem; text-transform: uppercase; }
        .trades-table tr:hover { background: #222; }
        .trade-long { color: #00ff88; }
        .trade-short { color: #ff6666; }
        .trade-profit { color: #00ff88; }
        .trade-loss { color: #ff4444; }
        .auto-refresh { position: fixed; top: 20px; right: 20px; background: #333; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; }
        .timestamp { font-size: 0.8rem; color: #666; }
        .no-data { text-align: center; padding: 40px; color: #666; font-style: italic; }
        @media (max-width: 768px) {
            .metrics-grid { grid-template-columns: 1fr; }
            .trades-table { font-size: 0.8rem; }
            .trades-table th, .trades-table td { padding: 8px 4px; }
        }
    </style>
</head>
<body>
    <div class="auto-refresh" id="refreshStatus">Auto-refresh: <span id="countdown">30s</span></div>
    
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Live Trading Dashboard</h1>
            <div class="status-badge" id="systemStatus"><span id="statusText">Loading...</span></div>
            <div class="timestamp">Last updated: <span id="updateTime">--</span></div>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="currentEquity">$--</div>
                <div class="metric-label">Current Equity</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalReturn">--%</div>
                <div class="metric-label">Total Return</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalTrades">--</div>
                <div class="metric-label">Total Trades</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="winRate">--%</div>
                <div class="metric-label">Win Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalPnL">$--</div>
                <div class="metric-label">Total P&L</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="lastPrice">$--</div>
                <div class="metric-label">Current Price</div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-header">
                <div class="section-title">Recent Trades</div>
            </div>
            <table class="trades-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Entry Price</th>
                        <th>Close Price</th>
                        <th>Quantity</th>
                        <th>P&L</th>
                        <th>Status</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="tradesTableBody">
                    <tr><td colspan="8" class="no-data">Loading trades...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <div class="section-header">
                <div class="section-title">System Information</div>
            </div>
            <div style="padding: 20px;">
                <div><strong>Symbol:</strong> <span id="tradingSymbol">--</span></div>
                <div><strong>Strategy:</strong> <span id="strategy">--</span></div>
                <div><strong>Session Uptime:</strong> <span id="uptime">--</span></div>
                <div><strong>Last Candle:</strong> <span id="lastCandle">--</span></div>
                <div><strong>Open Positions:</strong> <span id="openPositions">--</span></div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval, countdownInterval, countdown = 30;
        
        async function fetchData() {
            try {
                const data = await fetch('/api/dashboard').then(r => r.json());
                updateDashboard(data);
                updateStatus('active', 'System Active');
            } catch (error) {
                console.error('Failed to fetch data:', error);
                updateStatus('inactive', 'Connection Error');
            }
        }
        
        function updateDashboard(data) {
            document.getElementById('currentEquity').textContent = data.portfolio?.equity ? `$${data.portfolio.equity.toLocaleString()}` : '$--';
            
            const returnValue = data.portfolio?.totalReturn || 0;
            const returnElement = document.getElementById('totalReturn');
            returnElement.textContent = `${returnValue.toFixed(2)}%`;
            returnElement.className = `metric-value ${returnValue >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('totalTrades').textContent = data.metrics?.totalTrades || '0';
            document.getElementById('winRate').textContent = `${(data.metrics?.winRate || 0).toFixed(1)}%`;
            
            const totalPnL = data.metrics?.totalPnL || 0;
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = `$${totalPnL.toFixed(2)}`;
            pnlElement.className = `metric-value ${totalPnL >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('lastPrice').textContent = data.lastPrice ? `$${data.lastPrice.toLocaleString()}` : '$--';
            document.getElementById('tradingSymbol').textContent = data.symbol || '--';
            document.getElementById('strategy').textContent = data.strategy || '--';
            document.getElementById('uptime').textContent = formatUptime(data.uptime || 0);
            document.getElementById('lastCandle').textContent = data.lastCandleTime ? new Date(data.lastCandleTime).toLocaleString() : '--';
            document.getElementById('openPositions').textContent = data.openPositions || '0';
            
            updateTradesTable(data.recentTrades || []);
            document.getElementById('updateTime').textContent = new Date().toLocaleString();
        }
        
        function updateTradesTable(trades) {
            const tbody = document.getElementById('tradesTableBody');
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No trades executed yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = trades.map(trade => {
                const typeClass = trade.type === 'BUY' || trade.type === 'LONG' ? 'trade-long' : 'trade-short';
                const pnlClass = (trade.pnl || 0) >= 0 ? 'trade-profit' : 'trade-loss';
                const pnlText = trade.pnl !== undefined ? `$${trade.pnl.toFixed(2)}` : '--';
                const exitPriceText = trade.exitPrice ? `$${trade.exitPrice.toLocaleString()}` : '--';
                
                return `
                    <tr>
                        <td>${formatTime(trade.entryTime || trade.timestamp)}</td>
                        <td class="${typeClass}">${trade.type || 'N/A'}</td>
                        <td>$${(trade.entryPrice || trade.price || 0).toLocaleString()}</td>
                        <td>${exitPriceText}</td>
                        <td>${(trade.quantity || 0).toFixed(6)}</td>
                        <td class="${pnlClass}">${pnlText}</td>
                        <td>${trade.status || 'OPEN'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${trade.reason || '--'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStatus(status, text) {
            const statusElement = document.getElementById('systemStatus');
            statusElement.className = `status-badge status-${status}`;
            document.getElementById('statusText').textContent = text;
        }
        
        function formatTime(timestamp) {
            return timestamp ? new Date(timestamp).toLocaleTimeString() : '--';
        }
        
        function formatUptime(milliseconds) {
            const hours = Math.floor(milliseconds / (1000 * 60 * 60));
            const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${minutes}m`;
        }
        
        function startCountdown() {
            countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('countdown').textContent = `${countdown}s`;
                if (countdown <= 0) {
                    countdown = 30;
                    fetchData();
                }
            }, 1000);
        }
        
        function startAutoRefresh() {
            fetchData();
            refreshInterval = setInterval(fetchData, 30000);
            startCountdown();
        }
        
        document.addEventListener('DOMContentLoaded', startAutoRefresh);
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(refreshInterval);
                clearInterval(countdownInterval);
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>